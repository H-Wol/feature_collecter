import os
from api.api import API
from api.config.config import ConfigMgr


class MalwareBazzar(API):
    def __init__(self):
        self.url = "https://mb-api.abuse.ch/api/v1/"
        self.config = ConfigMgr().get_instance()

    def get_task_info(self, datas: dict, group_name: str):
        task_info = list()
        keys = datas.keys()
        self.save_dir = self.config.get_config2("DIR", "save_dir")
        self.save_dir = os.path.join(self.save_dir, group_name)
        os.makedirs(self.save_dir, exist_ok=True)

        hashs = ["MD5", "SHA-256", "SHA-1"] # Malware_Bazzar은 File Hash에 대한  API만 존재
        for key in keys:
            if key in hashs:
                for data in datas[key]:
                    task_info.append(self.get_hash_info(data))
            else:
                pass
        return task_info

    def get_hash_info(self, str):
        """
        파일 Hash 정보 관련 API
        """
        task_info = super().get_default_dict()
        task_info["type"] = "POST"
        task_info["url"] = self.url
        task_info["save_dir"] = self.get_save_dir(str)
        task_info["data"] = {"hash": str, "query": "get_info"}
        return task_info

    def get_save_dir(self, str):
        return os.path.join(self.save_dir, "{}_MalwareBazaar.json".format(str))
